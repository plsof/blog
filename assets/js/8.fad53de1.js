(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{392:function(t,s,a){t.exports=a.p+"assets/img/prometheus-operator.e8a23cc2.png"},393:function(t,s,a){t.exports=a.p+"assets/img/wtvPrometheus.6a483b7a.png"},428:function(t,s,a){"use strict";a.r(s);var e=a(54),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),e("h3",{attrs:{id:"前提"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前提"}},[t._v("#")]),t._v(" 前提")]),t._v(" "),e("p",[t._v("这里我们使用"),e("code",[t._v("Prometheus")]),t._v("监控Kubernetes集群状态，配置"),e("code",[t._v("Prometheus")]),t._v("的成本非常高，而且也非常麻烦。如果我们还要考虑"),e("code",[t._v("Prometheus")]),t._v("、"),e("code",[t._v("AlertManager")]),t._v("这些组件服务本身的高可用的话，成本就更高了。因此我们可以使用另外一种更加高级的方式来部署"),e("code",[t._v("Prometheus")]),t._v("："),e("code",[t._v("Operator")]),t._v("框架")]),t._v(" "),e("h3",{attrs:{id:"operator"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#operator"}},[t._v("#")]),t._v(" Operator")]),t._v(" "),e("p",[e("code",[t._v("Operator")]),t._v("是由CoreOS开发的，用来扩展Kubernetes API，特定的应用程序控制器，它用来创建、配置和管理复杂的有状态应用，如数据库、缓存和监控系统。"),e("code",[t._v("Operator")]),t._v("基于Kubernetes的资源和控制器概念之上构建，但同时又包含了应用程序特定的领域知识。创建"),e("code",[t._v("Operator")]),t._v("的关键是CRD（自定义资源）的设计。")]),t._v(" "),e("p",[e("strong",[t._v("架构图")])]),t._v(" "),e("img",{attrs:{src:a(392),alt:"Prometheus Operator"}}),t._v(" "),e("h2",{attrs:{id:"安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),e("h3",{attrs:{id:"helm安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#helm安装"}},[t._v("#")]),t._v(" helm安装")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("helm repo "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" stable https://kubernetes-charts.storage.googleapis.com/\nkubectl create namespace monitoring\nhelm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" prometheus-operator --namespace monitoring stable/prometheus-operator\n")])])]),e("h3",{attrs:{id:"源码安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#源码安装"}},[t._v("#")]),t._v(" 源码安装")]),t._v(" "),e("p",[t._v("版本："),e("code",[t._v("v0.3.0")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/coreos/kube-prometheus/archive/v0.3.0.tar.gz\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxv -f v0.3.0.tar.gz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" kube-prometheus-0.3.0\nkubectl apply -f manifests/setup\nkubectl apply -f manifests\n")])])]),e("p",[t._v("部署完成后，会创建一个monitoring的namespace，所有的资源对象都将部署在这个命名空间下面。")]),t._v(" "),e("p",[e("code",[t._v("CRD")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master manifests"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get crd | grep coreos")]),t._v("\nalertmanagers.monitoring.coreos.com     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-03-08T15:50:21Z\npodmonitors.monitoring.coreos.com       "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-03-08T15:50:21Z\nprometheuses.monitoring.coreos.com      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-03-08T15:50:22Z\nprometheusrules.monitoring.coreos.com   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-03-08T15:50:22Z\nservicemonitors.monitoring.coreos.com   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-03-08T15:50:22Z\n")])])]),e("p",[e("code",[t._v("POD")]),t._v(" alertmanager和prometheus是用StatefulSet控制器管理的，其中还有一个比较核心的Pod prometheus-operator，用来控制其他资源对象和监听对象变化")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master manifests"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pod -n monitoring")]),t._v("\nNAME                                  READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          16h\nalertmanager-main-1                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          16h\nalertmanager-main-2                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          16h\ngrafana-58dc7468d7-7nx9d              "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nkube-state-metrics-78b46c84d8-hc8cm   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/3     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nnode-exporter-2sgf6                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nnode-exporter-66sh6                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nnode-exporter-74mx4                   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nprometheus-adapter-5cd5798d96-x6rcs   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\nprometheus-k8s-0                      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/3     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          44h\nprometheus-k8s-1                      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/3     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          44h\nprometheus-operator-99dccdc56-x6htc   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2d11h\n")])])]),e("p",[e("code",[t._v("SVC")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master manifests"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get svc -n monitoring")]),t._v("\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                      AGE\nalertmanager-main       ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.101")]),t._v(".142.157   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9093")]),t._v("/TCP                     2d11h\nalertmanager-operated   ClusterIP   None             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9093")]),t._v("/TCP,9094/TCP,9094/UDP   2d11h\ngrafana                 ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.98")]),t._v(".84.141     "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v("/TCP                     2d11h\nkube-state-metrics      ClusterIP   None             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),t._v("/TCP,9443/TCP            2d11h\nnode-exporter           ClusterIP   None             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9100")]),t._v("/TCP                     2d11h\nprometheus-adapter      ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.106")]),t._v(".199.108   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP                      2d11h\nprometheus-k8s          ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.109")]),t._v(".190.166   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9090")]),t._v("/TCP                     2d11h\nprometheus-operated     ClusterIP   None             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9090")]),t._v("/TCP                     2d11h\nprometheus-operator     ClusterIP   None             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP                     2d11h\n")])])]),e("h2",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),e("p",[e("strong",[t._v("以下配置是基于源码安装")])]),t._v(" "),e("h3",{attrs:{id:"k8s组件监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s组件监控"}},[t._v("#")]),t._v(" k8s组件监控")]),t._v(" "),e("p",[e("code",[t._v("Operator")]),t._v("默认监控了"),e("code",[t._v("Kubernetes")]),t._v("的大多数组件，但有些组件没有监控到，比如"),e("code",[t._v("kube-scheduler")]),t._v("、"),e("code",[t._v("kube-controller-manager")]),t._v("。这就跟ServiceMonitor里面的定义有关了")]),t._v(" "),e("h4",{attrs:{id:"kube-scheduler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kube-scheduler"}},[t._v("#")]),t._v(" kube-scheduler")]),t._v(" "),e("p",[e("em",[t._v("prometheus-serviceMonitorKubeScheduler.yaml里面定义的svc没有创建")])]),t._v(" "),e("p",[t._v("手动创建svc\n"),e("code",[t._v("prometheus-kubeSchedulerService.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scheduler\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k8s-app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scheduler\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scheduler\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("metrics\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10251")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10251")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl apply -f prometheus-kubeSchedulerService.yaml\n")])])]),e("p",[e("em",[t._v("现在可以看到这个target，但是抓取数据出错，这个错误是因为我们集群是使用"),e("code",[t._v("kubeadm")]),t._v("搭建的，其中"),e("code",[t._v("kube-scheduler")]),t._v("默认是绑定在127.0.0.1上面的，而上面我们这个地方是想通过节点的IP去访问，所以访问被拒绝了，我们只要把"),e("code",[t._v("kube-scheduler")]),t._v("绑定的地址更改成0.0.0.0即可满足要求，由于"),e("code",[t._v("kube-scheduler")]),t._v("是以静态"),e("code",[t._v("Pod")]),t._v("的形式运行在集群中的，所以我们只需要更改静态"),e("code",[t._v("Pod")]),t._v("目录下面对应的YAML文件配置即可")])]),t._v(" "),e("p",[t._v("修改静态Pod配置\n"),e("code",[t._v("/etc/kubernetes/manifests/kube-scheduler.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("bind"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("address=0.0.0.0\n")])])]),e("h4",{attrs:{id:"kube-controller-manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kube-controller-manager"}},[t._v("#")]),t._v(" kube-controller-manager")]),t._v(" "),e("p",[e("em",[t._v("异常原因和解决方法同上")])]),t._v(" "),e("p",[t._v("手动创建svc")]),t._v(" "),e("p",[e("code",[t._v("prometheus-KubeControllerManagerService.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("controller"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("manager\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k8s-app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("controller"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("manager\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("controller"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("manager\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("metrics\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10252")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10252")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl apply -f prometheus-KubeControllerManagerService.yaml\n")])])]),e("p",[t._v("修改静态Pod配置\n"),e("code",[t._v("/etc/kubernetes/manifests/kube-controller-manager.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("bind"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("address=0.0.0.0\n")])])]),e("h3",{attrs:{id:"grafana"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#grafana"}},[t._v("#")]),t._v(" grafana")]),t._v(" "),e("p",[t._v("默认已经配置好，可使用默认账号、密码"),e("code",[t._v("admin:admin")]),t._v("登录查看")]),t._v(" "),e("h3",{attrs:{id:"数据持久化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据持久化"}},[t._v("#")]),t._v(" 数据持久化")]),t._v(" "),e("p",[t._v("Pod "),e("code",[t._v("prometheus")]),t._v("和"),e("code",[t._v("alertmanager")]),t._v("默认用的"),e("code",[t._v("emptyDir")]),t._v("存储，没有做数据持久化。Pod重启后数据就丢失了")]),t._v(" "),e("p",[t._v("配置数据持久化")]),t._v(" "),e("ol",[e("li",[t._v("prometheus")])]),t._v(" "),e("p",[e("code",[t._v("prometheus-prometheus.yaml")])]),t._v(" "),e("p",[t._v("添加")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumeClaimTemplate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storageClassName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" managed"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nfs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("storage\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n")])])]),e("p",[t._v("验证")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pvc -n monitoring")]),t._v("\nNAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\nprometheus-k8s-db-prometheus-k8s-0   Bound    pvc-1b09ac85-c23f-4511-a9e1-015491647aeb   1Gi        RWO            managed-nfs-storage   3d8h\nprometheus-k8s-db-prometheus-k8s-1   Bound    pvc-54203f65-a8b8-4f87-af9b-a11f5e52545c   1Gi        RWO            managed-nfs-storage   3d8h\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pv")]),t._v("\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                           STORAGECLASS          REASON   AGE\npvc-1b09ac85-c23f-4511-a9e1-015491647aeb   1Gi        RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-0   managed-nfs-storage            3d8h\npvc-54203f65-a8b8-4f87-af9b-a11f5e52545c   1Gi        RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-1   managed-nfs-storage            3d8h\n")])])]),e("h3",{attrs:{id:"告警配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#告警配置"}},[t._v("#")]),t._v(" 告警配置")]),t._v(" "),e("p",[t._v("AlertManager配置各种告警收发器")]),t._v(" "),e("p",[t._v("Service "),e("code",[t._v("alertmanager-main")]),t._v("上的status页面可以看到"),e("code",[t._v("AlertManager")]),t._v("的配置信息")]),t._v(" "),e("p",[t._v("Config")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("global")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resolve_timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http_config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_hello")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" localhost\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_require_tls")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pagerduty_url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//events.pagerduty.com/v2/enqueue\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hipchat_api_url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//api.hipchat.com/\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("opsgenie_api_url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//api.opsgenie.com/\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("wechat_api_url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//qyapi.weixin.qq.com/cgi"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("bin/\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("victorops_api_url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//alert.victorops.com/integrations/generic/20131114/alert/\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_by")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" job\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("routes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("alertname")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Watchdog\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_wait")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("repeat_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 12h\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receivers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("templates")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("p",[t._v("这些配置信息实际上是来自于我们之前在manifests目录下面创建的"),e("code",[t._v("alertmanager-secret.yaml")]),t._v("文件")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("alertmanager.yaml")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Imdsb2JhbCI6CiAgInJlc29sdmVfdGltZW91dCI6ICI1bSIKInJlY2VpdmVycyI6Ci0gIm5hbWUiOiAibnVsbCIKInJvdXRlIjoKICAiZ3JvdXBfYnkiOgogIC0gImpvYiIKICAiZ3JvdXBfaW50ZXJ2YWwiOiAiNW0iCiAgImdyb3VwX3dhaXQiOiAiMzBzIgogICJyZWNlaXZlciI6ICJudWxsIgogICJyZXBlYXRfaW50ZXJ2YWwiOiAiMTJoIgogICJyb3V0ZXMiOgogIC0gIm1hdGNoIjoKICAgICAgImFsZXJ0bmFtZSI6ICJXYXRjaGRvZyIKICAgICJyZWNlaXZlciI6ICJudWxsIg==\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Secret\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" alertmanager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("main\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" monitoring\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Opaque\n")])])]),e("p",[t._v("将"),e("code",[t._v("alertmanager.yaml")]),t._v("对应的value值做一个base64解码")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master kube-prometheus"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo Imdsb2JhbCI6CiAgInJlc29sdmVfdGltZW91dCI6ICI1bSIKInJlY2VpdmVycyI6Ci0gIm5hbWUiOiAibnVsbCIKInJvdXRlIjoKICAiZ3JvdXBfYnkiOgogIC0gImpvYiIKICAiZ3JvdXBfaW50ZXJ2YWwiOiAiNW0iCiAgImdyb3VwX3dhaXQiOiAiMzBzIgogICJyZWNlaXZlciI6ICJudWxsIgogICJyZXBlYXRfaW50ZXJ2YWwiOiAiMTJoIgogICJyb3V0ZXMiOgogIC0gIm1hdGNoIjoKICAgICAgImFsZXJ0bmFtZSI6ICJXYXRjaGRvZyIKICAgICJyZWNlaXZlciI6ICJudWxsIg== | base64 -d")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"global"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resolve_timeout"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5m"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"receivers"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n- "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"route"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"group_by"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n  - "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"job"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"group_interval"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5m"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"group_wait"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"30s"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"receiver"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"repeat_interval"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"12h"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"routes"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n  - "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"match"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alertname"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Watchdog"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"receiver"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"null"')]),t._v("\n")])])]),e("p",[t._v("我们可以看到内容和上面查看的配置信息是一致的，所以如果我们想要添加自己的接收器，或者模板消息，我们就可以更改这个secret。")]),t._v(" "),e("ol",[e("li",[t._v("邮件")])]),t._v(" "),e("p",[e("code",[t._v("alertmanager.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("global")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resolve_timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_smarthost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'smtp.qq.com:465'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'254995740@qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_auth_username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'254995740@qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_auth_password")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sbphoqcqmkovqwer'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_hello")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_require_tls")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_by")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alertname'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_wait")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("repeat_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("routes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" email\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_wait")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receivers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("email_configs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("to")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1103901630@qq.com'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("send_resolved")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'email'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("email_configs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("to")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1103901630@qq.com'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("send_resolved")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),e("p",[t._v("删除原secret，创建对应新的secret")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl delete secret alertmanager-main -n monitoring\nkubectl create secret generic alertmanager-main --from-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("alertmanager.yaml -n monitoring\n")])])]),e("p",[t._v("自定义告警模版")]),t._v(" "),e("ol",[e("li",[t._v("邮件告警")])]),t._v(" "),e("p",[e("code",[t._v("alertmanager.tmpl")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(' define "email.default.html" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" range .Alerts "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n========start========== <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("告警程序")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prometheus_alert <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("告警级别")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" .Labels.severity "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("告警类型")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" .Labels.alertname "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("故障主机")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" .Labels.instance "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("告警主题")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" .Annotations.summary "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("告警详情")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" .Annotations.description "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("触发时间")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(' .StartsAt.Format "2020'),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("03"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("10 23"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("11"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('05" '),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n========end========== <br"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" end "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" end "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[e("code",[t._v("alertmanager.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("global")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resolve_timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_smarthost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'smtp.qq.com:465'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'254995740@qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_auth_username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'254995740@qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_auth_password")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'lvirtwyfzzklqwer'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_hello")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qq.com'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("smtp_require_tls")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("templates")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*.tmpl'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_by")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alertname'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_wait")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("repeat_interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("routes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receiver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" email\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group_wait")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receivers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("email_configs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("to")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1103901630@qq.com'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("send_resolved")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'email'")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("email_configs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("to")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1103901630@qq.com'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("send_resolved")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),e("p",[t._v("删除原secret，创建对应新的secret")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl delete secret alertmanager-main -n monitoring\nkubectl create secret generic alertmanager-main --from-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("alertmanager.yaml --from-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("alertmanager.tmpl -n monitoring\n")])])]),e("h3",{attrs:{id:"自定义监控项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#自定义监控项"}},[t._v("#")]),t._v(" 自定义监控项")]),t._v(" "),e("p",[t._v("除了Kubernetes集群中的一些资源对象、节点以及组件需要监控，有的时候我们可能还需要根据实际的业务需求去添加自定义的监控项。")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("新建一个获取metrics数据的Service对象（数据格式必须为Prometheus）")])]),t._v(" "),e("li",[e("p",[t._v("新建一个ServiceMonitor对象，关联上面的Service")])])]),t._v(" "),e("p",[t._v("ServiceMonitor是Prometheus Operator中抽象的概念，他的作用是将配置Prometheus采集Target的配置变化成为动态发现的方式")]),t._v(" "),e("p",[e("em",[t._v("案例：配置Prometheus监控节目单")])]),t._v(" "),e("p",[e("code",[t._v("创建Service prometheus-wtvService.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("monitor\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterIP\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterIP")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtvport\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Endpoints\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("monitor\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subsets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addresses")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ip")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.25.172.232"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtvport\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v("\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl create -f prometheus-wtvService.yaml\n")])])]),e("p",[e("code",[t._v("创建ServiceMonitor prometheus-serviceMonitorWtv.yaml")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" monitoring.coreos.com/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ServiceMonitor\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("monitor\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" monitoring\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("monitor\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtvport\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 300s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaceSelector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchNames")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" default\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wtv\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl create -f prometheus-serviceMonitorWtv.yaml\n")])])]),e("p",[e("code",[t._v("Dashboard查看对应target")])]),t._v(" "),e("img",{attrs:{src:a(393),alt:"Wtv Prometheus"}}),t._v(" "),e("h3",{attrs:{id:"监控自动发现配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控自动发现配置"}},[t._v("#")]),t._v(" 监控自动发现配置")]),t._v(" "),e("h3",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),e("p",[e("code",[t._v("https://www.cnblogs.com/xzkzzz/p/10532002.html")])])])}),[],!1,null,null,null);s.default=n.exports}}]);